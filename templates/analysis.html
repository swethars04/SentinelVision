{% extends "base.html" %}

{% block title %}Analysis Details{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Analyses</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ analysis.filename }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="h2 mb-1">
                    <i class="fas fa-video me-2"></i>{{ analysis.filename }}
                </h1>
                <p class="text-muted">
                    Uploaded on {{ analysis.upload_time.strftime('%B %d, %Y at %H:%M') }}
                </p>
            </div>
            <div class="text-end">
                <span class="badge bg-{{ 'success' if analysis.processing_status == 'completed' else 'warning' if analysis.processing_status == 'processing' else 'danger' if analysis.processing_status == 'failed' else 'secondary' }} fs-6">
                    {{ analysis.processing_status.title() }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Video Analysis Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Analysis Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2 col-sm-4 mb-3">
                        <div class="text-center">
                            <div class="h4 text-primary mb-1">{{ "%.1f"|format(analysis.duration or 0) }}s</div>
                            <small class="text-muted">Duration</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-4 mb-3">
                        <div class="text-center">
                            <div class="h4 text-info mb-1">{{ analysis.total_frames or 0 }}</div>
                            <small class="text-muted">Total Frames</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-4 mb-3">
                        <div class="text-center">
                            <div class="h4 text-success mb-1">{{ analysis.total_persons_detected or 0 }}</div>
                            <small class="text-muted">Persons Detected</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-4 mb-3">
                        <div class="text-center">
                            <div class="h4 text-secondary mb-1">{{ analysis.total_objects_detected or 0 }}</div>
                            <small class="text-muted">Objects Detected</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-4 mb-3">
                        <div class="text-center">
                            <div class="h4 text-warning mb-1">{{ analysis.total_anomalies or 0 }}</div>
                            <small class="text-muted">Anomalies Found</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-4 mb-3">
                        <div class="text-center">
                            <div class="h4 text-danger mb-1">{{ alerts|selectattr('alert_level', 'equalto', 'danger')|list|length }}</div>
                            <small class="text-muted">Critical Alerts</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Video Player and Actions -->
{% if analysis.processing_status == 'completed' %}
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-play me-2"></i>Video Playback
                </h5>
            </div>
            <div class="card-body">
                <div class="ratio ratio-16x9">
                    <video controls class="rounded">
                        {% if analysis.processed_video_path %}
                            <source src="{{ url_for('serve_processed_video', filename=analysis.processed_video_path.split('/')[-1]) }}" type="video/mp4">
                        {% else %}
                            <source src="{{ url_for('serve_video', filename=analysis.filename) }}" type="video/mp4">
                        {% endif %}
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="mt-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary" onclick="toggleOriginal()">
                            <i class="fas fa-eye me-1"></i>Toggle Original/Processed
                        </button>
                        {% if analysis.processed_video_path %}
                            <a href="{{ url_for('serve_processed_video', filename=analysis.processed_video_path.split('/')[-1]) }}" 
                               class="btn btn-outline-success" download>
                                <i class="fas fa-download me-1"></i>Download Processed
                            </a>
                        {% endif %}
                        <a href="{{ url_for('serve_video', filename=analysis.filename) }}" 
                           class="btn btn-outline-secondary" download>
                            <i class="fas fa-download me-1"></i>Download Original
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="exportReport()">
                        <i class="fas fa-file-pdf me-2"></i>Export Analysis Report
                    </button>
                    <button class="btn btn-outline-info" onclick="shareAnalysis()">
                        <i class="fas fa-share me-2"></i>Share Analysis
                    </button>
                    <button class="btn btn-outline-warning" onclick="reprocessVideo()">
                        <i class="fas fa-redo me-2"></i>Reprocess Video
                    </button>
                    <hr>
                    <button class="btn btn-outline-success" onclick="markAllResolved()">
                        <i class="fas fa-check me-2"></i>Mark All Resolved
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteAnalysis()">
                        <i class="fas fa-trash me-2"></i>Delete Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Anomalies and Alerts -->
<div class="row">
    <!-- Detected Anomalies -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Detected Anomalies ({{ anomalies|length }})
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="anomalyFilter" id="allAnomalies" autocomplete="off" checked>
                    <label class="btn btn-outline-secondary" for="allAnomalies">All</label>
                    
                    <input type="radio" class="btn-check" name="anomalyFilter" id="unresolvedAnomalies" autocomplete="off">
                    <label class="btn btn-outline-warning" for="unresolvedAnomalies">Unresolved</label>
                    
                    <input type="radio" class="btn-check" name="anomalyFilter" id="highSeverity" autocomplete="off">
                    <label class="btn btn-outline-danger" for="highSeverity">High Severity</label>
                </div>
            </div>
            <div class="card-body">
                {% if anomalies %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Time</th>
                                    <th>Severity</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="anomaliesTable">
                                {% for anomaly in anomalies %}
                                    <tr data-anomaly-id="{{ anomaly.id }}" 
                                        data-severity="{{ anomaly.severity }}" 
                                        data-resolved="{{ anomaly.is_resolved }}">
                                        <td>
                                            <span class="badge bg-info">
                                                {{ anomaly.anomaly_type.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <div>{{ "%.1f"|format(anomaly.start_timestamp) }}s</div>
                                            {% if anomaly.end_timestamp %}
                                                <small class="text-muted">
                                                    Duration: {{ "%.1f"|format(anomaly.end_timestamp - anomaly.start_timestamp) }}s
                                                </small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if anomaly.severity == 'critical' else 'warning' if anomaly.severity == 'high' else 'info' if anomaly.severity == 'medium' else 'secondary' }}">
                                                {{ anomaly.severity.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <div>{{ anomaly.description or 'No description available' }}</div>
                                            <small class="text-muted">
                                                Confidence: {{ "%.2f"|format(anomaly.confidence or 0) }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if anomaly.is_resolved %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Resolved
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="seekToTime({{ anomaly.start_timestamp }})"
                                                        title="Go to timestamp">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                {% if not anomaly.is_resolved %}
                                                    <button class="btn btn-sm btn-outline-success" 
                                                            onclick="resolveAnomaly({{ anomaly.id }})"
                                                            title="Mark as resolved">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="viewAnomalyDetails({{ anomaly.id }})"
                                                        title="View details">
                                                    <i class="fas fa-info"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                        <h5 class="text-success">No Anomalies Detected</h5>
                        <p class="text-muted">This video appears to be free of suspicious activities.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Alerts Timeline -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Alert Timeline ({{ alerts|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if alerts %}
                    <div class="timeline">
                        {% for alert in alerts %}
                            <div class="timeline-item mb-3">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-{{ 'exclamation-triangle' if alert.alert_level == 'danger' else 'exclamation-circle' if alert.alert_level == 'warning' else 'info-circle' }} text-{{ alert.alert_level }}"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="fw-bold">{{ alert.alert_level.title() }} Alert</div>
                                        <div class="text-muted small mb-1">
                                            {{ alert.created_time.strftime('%H:%M:%S') }}
                                        </div>
                                        <div class="mb-2">{{ alert.message }}</div>
                                        {% if not alert.is_acknowledged %}
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="acknowledgeAlert({{ alert.id }})">
                                                <i class="fas fa-check me-1"></i>Acknowledge
                                            </button>
                                        {% else %}
                                            <small class="text-success">
                                                <i class="fas fa-check me-1"></i>Acknowledged
                                                {% if alert.acknowledged_by %}
                                                    by {{ alert.acknowledged_by }}
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No alerts generated for this analysis.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let videoPlayer;
let showingProcessed = true;

document.addEventListener('DOMContentLoaded', function() {
    videoPlayer = document.querySelector('video');
    
    // Set up anomaly filters
    document.querySelectorAll('input[name="anomalyFilter"]').forEach(radio => {
        radio.addEventListener('change', filterAnomalies);
    });
});

// Filter anomalies based on selection
function filterAnomalies() {
    const selectedFilter = document.querySelector('input[name="anomalyFilter"]:checked').id;
    const rows = document.querySelectorAll('#anomaliesTable tr');
    
    rows.forEach(row => {
        const severity = row.getAttribute('data-severity');
        const resolved = row.getAttribute('data-resolved') === 'True';
        
        let show = true;
        
        switch (selectedFilter) {
            case 'unresolvedAnomalies':
                show = !resolved;
                break;
            case 'highSeverity':
                show = severity === 'high' || severity === 'critical';
                break;
            default: // allAnomalies
                show = true;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Toggle between original and processed video
function toggleOriginal() {
    if (!videoPlayer) return;
    
    const currentTime = videoPlayer.currentTime;
    const isPlaying = !videoPlayer.paused;
    
    if (showingProcessed) {
        videoPlayer.src = "{{ url_for('serve_video', filename=analysis.filename) }}";
    } else {
        {% if analysis.processed_video_path %}
            videoPlayer.src = "{{ url_for('serve_processed_video', filename=analysis.processed_video_path.split('/')[-1]) }}";
        {% endif %}
    }
    
    showingProcessed = !showingProcessed;
    
    videoPlayer.addEventListener('loadeddata', function() {
        videoPlayer.currentTime = currentTime;
        if (isPlaying) {
            videoPlayer.play();
        }
    }, { once: true });
}

// Seek to specific time in video
function seekToTime(timestamp) {
    if (videoPlayer) {
        videoPlayer.currentTime = timestamp;
        videoPlayer.play();
    }
}

// Resolve anomaly
function resolveAnomaly(anomalyId) {
    fetch(`/api/anomalies/${anomalyId}/resolve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI
            const row = document.querySelector(`tr[data-anomaly-id="${anomalyId}"]`);
            if (row) {
                row.setAttribute('data-resolved', 'True');
                const statusCell = row.cells[4];
                statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Resolved</span>';
                
                const actionCell = row.cells[5];
                const resolveBtn = actionCell.querySelector('.btn-outline-success');
                if (resolveBtn) {
                    resolveBtn.remove();
                }
            }
            
            // Show success message
            showToast('Anomaly marked as resolved', 'success');
        }
    })
    .catch(error => {
        console.error('Error resolving anomaly:', error);
        showToast('Error resolving anomaly', 'error');
    });
}

// Acknowledge alert
function acknowledgeAlert(alertId) {
    fetch(`/api/alerts/${alertId}/acknowledge`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            acknowledged_by: 'User'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show updated state
        }
    })
    .catch(error => {
        console.error('Error acknowledging alert:', error);
        showToast('Error acknowledging alert', 'error');
    });
}

// Utility functions
function exportReport() {
    window.print();
}

function shareAnalysis() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        showToast('Analysis link copied to clipboard', 'success');
    });
}

function reprocessVideo() {
    if (confirm('Reprocess this video? This will overwrite existing analysis results.')) {
        // Implementation would go here
        showToast('Video reprocessing started', 'info');
    }
}

function markAllResolved() {
    if (confirm('Mark all anomalies as resolved?')) {
        // Implementation would go here
        showToast('All anomalies marked as resolved', 'success');
    }
}

function deleteAnalysis() {
    if (confirm('Delete this analysis? This action cannot be undone.')) {
        // Implementation would go here
        window.location.href = '/dashboard';
    }
}

function viewAnomalyDetails(anomalyId) {
    // Implementation would show detailed anomaly information
    showToast('Anomaly details feature coming soon', 'info');
}

function showToast(message, type) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}
