{% extends "base.html" %}

{% block title %}Upload Video{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-upload me-2"></i>Upload Video for Analysis
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <!-- File Upload Area -->
                    <div class="mb-4">
                        <label for="video" class="form-label">Select Video File</label>
                        <div class="border-2 border-dashed border-secondary rounded p-4 text-center" id="dropZone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="mb-2">Drag and drop your video file here, or click to browse</p>
                            <p class="text-muted small">Supported formats: MP4, AVI, MOV, MKV, FLV, WMV (Max: 500MB)</p>
                            <input type="file" class="form-control d-none" id="video" name="video" accept=".mp4,.avi,.mov,.mkv,.flv,.wmv" required>
                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('video').click()">
                                <i class="fas fa-folder-open me-2"></i>Browse Files
                            </button>
                        </div>
                        <div class="mt-2" id="fileInfo" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-file-video me-2"></i>
                                <strong>Selected:</strong> <span id="fileName"></span>
                                <span class="ms-2 text-muted">(<span id="fileSize"></span>)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Options -->
                    <div class="mb-4">
                        <h5 class="mb-3">Analysis Options</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-eye me-2"></i>Object Detection
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="detectPersons" checked>
                                            <label class="form-check-label" for="detectPersons">
                                                Detect Persons
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="detectObjects" checked>
                                            <label class="form-check-label" for="detectObjects">
                                                Detect Objects
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="trackMovement" checked>
                                            <label class="form-check-label" for="trackMovement">
                                                Track Movement
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Anomaly Detection
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="detectLoitering" checked>
                                            <label class="form-check-label" for="detectLoitering">
                                                Loitering Detection
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="detectAbandoned" checked>
                                            <label class="form-check-label" for="detectAbandoned">
                                                Abandoned Objects
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="detectSuspicious" checked>
                                            <label class="form-check-label" for="detectSuspicious">
                                                Suspicious Movement
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sensitivity Settings -->
                    <div class="mb-4">
                        <h5 class="mb-3">Detection Sensitivity</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="confidenceThreshold" class="form-label">Object Detection Confidence</label>
                                <input type="range" class="form-range" id="confidenceThreshold" min="0.1" max="1.0" step="0.1" value="0.5">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>Low</span>
                                    <span id="confidenceValue">0.5</span>
                                    <span>High</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="loiteringThreshold" class="form-label">Loitering Time (seconds)</label>
                                <input type="range" class="form-range" id="loiteringThreshold" min="5" max="60" step="5" value="15">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>5s</span>
                                    <span id="loiteringValue">15s</span>
                                    <span>60s</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="abandonedThreshold" class="form-label">Abandoned Object Time (seconds)</label>
                                <input type="range" class="form-range" id="abandonedThreshold" min="2" max="30" step="2" value="10">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>2s</span>
                                    <span id="abandonedValue">10s</span>
                                    <span>30s</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Info -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>Processing Information
                        </h6>
                        <ul class="mb-0">
                            <li>Video processing may take several minutes depending on file size and duration</li>
                            <li>You'll be redirected to the dashboard where you can monitor progress</li>
                            <li>Alerts will be generated automatically for detected anomalies</li>
                            <li>Processed videos with annotations will be available for download</li>
                        </ul>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-upload me-2"></i>Upload and Process Video
                        </button>
                    </div>

                    <!-- Progress Bar (hidden initially) -->
                    <div class="mt-3" id="uploadProgress" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Uploading...</small>
                            <small class="text-muted" id="progressPercent">0%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('video');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    
    // Range slider value updates
    const confidenceSlider = document.getElementById('confidenceThreshold');
    const loiteringSlider = document.getElementById('loiteringThreshold');
    const abandonedSlider = document.getElementById('abandonedThreshold');
    
    confidenceSlider.addEventListener('input', function() {
        document.getElementById('confidenceValue').textContent = this.value;
    });
    
    loiteringSlider.addEventListener('input', function() {
        document.getElementById('loiteringValue').textContent = this.value + 's';
    });
    
    abandonedSlider.addEventListener('input', function() {
        document.getElementById('abandonedValue').textContent = this.value + 's';
    });
    
    // Drag and drop functionality
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-primary');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    // Handle file selection
    function handleFileSelect(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        
        // Validate file type
        const allowedTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo'];
        if (!allowedTypes.some(type => file.type.includes(type))) {
            alert('Please select a valid video file (MP4, AVI, MOV)');
            fileInput.value = '';
            fileInfo.style.display = 'none';
            return;
        }
        
        // Validate file size (500MB limit)
        if (file.size > 500 * 1024 * 1024) {
            alert('File size must be less than 500MB');
            fileInput.value = '';
            fileInfo.style.display = 'none';
            return;
        }
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files.length) {
            alert('Please select a video file');
            return;
        }
        
        const formData = new FormData(uploadForm);
        
        // Show progress
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        uploadProgress.style.display = 'block';
        
        // Simulate upload progress (in real implementation, you'd use XMLHttpRequest)
        let progress = 0;
        const progressInterval = setInterval(function() {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
        }, 200);
        
        // Submit form
        fetch(uploadForm.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            clearInterval(progressInterval);
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressPercent').textContent = '100%';
            
            if (response.ok) {
                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);
            } else {
                throw new Error('Upload failed');
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload and Process Video';
            uploadProgress.style.display = 'none';
            alert('Upload failed. Please try again.');
            console.error('Upload error:', error);
        });
    });
});
</script>
{% endblock %}
